<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Climate Dashboard Deutschland</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<style>
body{
  font-family:Arial,sans-serif;
  padding:30px;
  background:#f4f6f8;
}

.tabs{
  display:flex;
  gap:20px;
  margin-bottom:30px;
}

.tab-button{
  padding:10px 20px;
  cursor:pointer;
  background:#ddd;
  border:none;
  border-radius:6px;
  font-weight:bold;
}

.tab-button.active{
  background:#444;
  color:white;
}

.tab-content{
  display:none;
}

.tab-content.active{
  display:block;
}

.chart-container{
  max-width:1500px;
  height:550px;
  margin:40px auto;
  background:white;
  padding:20px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

.stats{
  max-width:900px;
  margin:40px auto;
  background:white;
  padding:20px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

canvas{
  width:100% !important;
  height:100% !important;
}
</style>
</head>
<body>

<h1>Climate Dashboard Deutschland</h1>

<div class="tabs">
  <button class="tab-button active" onclick="switchTab('monthly')">Monatswerte</button>
  <button class="tab-button" onclick="switchTab('daily')">Tageshöchstwerte</button>
</div>

<!-- ================= MONATS DASHBOARD ================= -->

<div id="monthly" class="tab-content active">

<label>Parameter:</label>
<select id="paramSelect">
  <option value="rain">Niederschlag</option>
  <option value="temp">Temperatur</option>
  <option value="sun">Sonnenscheindauer</option>
</select>

<label>Monat:</label>
<select id="monthSelect">
  <option value="01">Januar</option>
  <option value="02">Februar</option>
  <option value="03">März</option>
  <option value="04">April</option>
  <option value="05">Mai</option>
  <option value="06">Juni</option>
  <option value="07">Juli</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Dezember</option>
</select>

<button onclick="resetMonthlyZoom()">Zoom zurücksetzen</button>

<div class="chart-container">
  <canvas id="monthlyChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="monthlyDeviationChart"></canvas>
</div>

<div class="stats">
  <h3>Statistik (1991-2020)</h3>
  <p><strong>Mittelwert:</strong> <span id="climateMean"></span></p>
  <h4>Top 3 höchste</h4>
  <ul id="topHigh"></ul>
  <h4>Top 3 niedrigste</h4>
  <ul id="topLow"></ul>
</div>

</div>

<!-- ================= TAGES DASHBOARD ================= -->

<div id="daily" class="tab-content">

<label>Jahr:</label>
<select id="yearSelect"></select>

<label>Zeitraum:</label>
<select id="rangeSelect">
  <option value="year">Ganzes Jahr</option>
  <option value="winter">Winter</option>
  <option value="spring">Frühling</option>
  <option value="summer">Sommer</option>
  <option value="autumn">Herbst</option>
  <option value="01">Januar</option>
  <option value="02">Februar</option>
  <option value="03">März</option>
  <option value="04">April</option>
  <option value="05">Mai</option>
  <option value="06">Juni</option>
  <option value="07">Juli</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Dezember</option>
</select>

<div class="chart-container">
  <canvas id="dailyChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="dailyDeviationChart"></canvas>
</div>

</div>

<script>

// ================= TAB SWITCH =================

function switchTab(tab){
  document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add("active");
  document.getElementById(tab).classList.add("active");
}

// ================= MONATSDATEN =================

let monthlyData=[];
let monthlyChart;
let monthlyDeviationChart;

fetch("data.json")
.then(res=>res.json())
.then(data=>{
  monthlyData=data;
  updateMonthly();
});

function updateMonthly(){

  const param=document.getElementById("paramSelect").value;
  const month=document.getElementById("monthSelect").value;

  const filtered=monthlyData.filter(e=>e.date.endsWith("-"+month));
  const labels=filtered.map(e=>e.date.substring(0,4));
  const values=filtered.map(e=>e[param]);

  const climatePeriod=filtered.filter(e=>{
    const y=parseInt(e.date.substring(0,4));
    return y>=1991 && y<=2020;
  });

  const climateMean=
    climatePeriod.reduce((s,e)=>s+e[param],0)/climatePeriod.length;

  let unit="";
  if(param==="rain") unit="mm";
  if(param==="temp") unit="°C";
  if(param==="sun") unit="Stunden";

  document.getElementById("climateMean").innerText=
    climateMean.toFixed(2)+" "+unit;

  const movingAverage=values.map((_,i)=>{
    if(i<29) return null;
    const slice=values.slice(i-29,i+1);
    return slice.reduce((a,b)=>a+b,0)/30;
  });

  if(monthlyChart) monthlyChart.destroy();

  monthlyChart=new Chart(document.getElementById("monthlyChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[
        { label:param+" ("+unit+")", data:values, backgroundColor:"gray" },
        { label:"30-jähriges Mittel", data:movingAverage, type:"line", borderColor:"black", pointRadius:0 }
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });

  let deviation;
  let colors;
  let label;

  if(param==="temp"){
    deviation=values.map(v=>parseFloat((v-climateMean).toFixed(1)));
    colors=deviation.map(v=>v>=0?"red":"blue");
    label="Abweichung (°C)";
  } else {
    deviation=values.map(v=>((v/climateMean)*100)-100);
    colors=deviation.map(v=>v>=0?"green":"brown");
    label="% Abweichung";
  }

  if(monthlyDeviationChart) monthlyDeviationChart.destroy();

  monthlyDeviationChart=new Chart(document.getElementById("monthlyDeviationChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[
        { label:label, data:deviation, backgroundColor:colors },
        { label:"0 Linie", data:new Array(deviation.length).fill(0), type:"line", borderColor:"black", borderDash:[6,6], pointRadius:0 }
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });
}

document.getElementById("paramSelect").addEventListener("change",updateMonthly);
document.getElementById("monthSelect").addEventListener("change",updateMonthly);

// ================= TAGESDATEN =================

let dailyData=[];
let dailyChart;
let dailyDeviationChart;

fetch("daily_tmax_1881_2026.json")
.then(res=>res.json())
.then(data=>{
  dailyData=data;

  const years=[...new Set(data.map(d=>d.date.substring(0,4)))];
  const select=document.getElementById("yearSelect");

  years.forEach(y=>{
    const opt=document.createElement("option");
    opt.value=y;
    opt.text=y;
    select.appendChild(opt);
  });

  select.value=years[years.length-1];
  updateDaily();
});

function updateDaily(){

  const year=document.getElementById("yearSelect").value;
  const range=document.getElementById("rangeSelect").value;

  let filtered=dailyData.filter(d=>d.date.startsWith(year));

  const seasonMap={
    winter:["12","01","02"],
    spring:["03","04","05"],
    summer:["06","07","08"],
    autumn:["09","10","11"]
  };

  if(range!=="year"){
    if(seasonMap[range]){
      filtered=filtered.filter(d=>seasonMap[range].includes(d.date.substring(5,7)));
    } else {
      filtered=filtered.filter(d=>d.date.substring(5,7)===range);
    }
  }

  const labels=filtered.map(d=>d.date);
  const values=filtered.map(d=>d.tmax);
  const climate=filtered.map(d=>d.climate_mean);
  const deviation=filtered.map(d=>d.tmax-d.climate_mean);

  if(dailyChart) dailyChart.destroy();

  dailyChart=new Chart(document.getElementById("dailyChart"),{
    type:"line",
    data:{
      labels:labels,
      datasets:[
        { label:"Tageshöchstwert (°C)", data:values, borderColor:"red", pointRadius:0 },
        { label:"1991-2020 Mittel (°C)", data:climate, borderColor:"black", borderDash:[6,6], pointRadius:0 }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{
          ticks:{
            callback:function(value,index){
              const date=labels[index];
              const month=date.substring(5,7);
              const day=date.substring(8,10);

              if(range==="year" || seasonMap[range]){
                if(day==="01"){
                  return new Date(date).toLocaleString("de-DE",{month:"short"});
                }
                return "";
              }

              return day;
            }
          }
        }
      }
    }
  });

  if(dailyDeviationChart) dailyDeviationChart.destroy();

  dailyDeviationChart=new Chart(document.getElementById("dailyDeviationChart"),{
    type:"line",
    data:{
      labels:labels,
      datasets:[
        {
          label:"Abweichung (°C)",
          data:deviation,
          borderWidth:2,
          pointRadius:0,
          fill:"origin",
          segment:{
            borderColor:ctx=>{
              const avg=(ctx.p0.parsed.y+ctx.p1.parsed.y)/2;
              return avg>=0?"red":"blue";
            },
            backgroundColor:ctx=>{
              const avg=(ctx.p0.parsed.y+ctx.p1.parsed.y)/2;
              return avg>=0
                ?"rgba(255,0,0,0.25)"
                :"rgba(0,150,255,0.25)";
            }
          }
        },
        {
          label:"0 Linie",
          data:new Array(deviation.length).fill(0),
          borderColor:"black",
          borderDash:[6,6],
          pointRadius:0,
          fill:false
        }
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });
}

document.getElementById("yearSelect").addEventListener("change",updateDaily);
document.getElementById("rangeSelect").addEventListener("change",updateDaily);

</script>
</body>
</html>
