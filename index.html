<script>

let monthlyData = [];
let monthlyChart;

fetch("data.json")
.then(r => r.json())
.then(data => {
  monthlyData = data;
  updateMonthly();
})
.catch(err => console.error("Fehler:", err));

function updateMonthly(){

  const filtered = monthlyData.slice(0,20);

  const labels = filtered.map(e => e.date);
  const values = filtered.map(e => e.temp);

  if(monthlyChart) monthlyChart.destroy();

  monthlyChart = new Chart(
    document.getElementById("monthlyChart"),
    {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: "gray"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    }
  );
}

</script>


/* ===============================
   TAB SWITCH
================================ */

function switchTab(tab){
  document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add("active");
  document.getElementById(tab).classList.add("active");
}

/* ===============================
   GLOBALE VARIABLEN
================================ */

let monthlyData = [];
let dailyData = [];

let monthlyChart, monthlyDeviationChart;
let dailyChart, dailyDeviationChart, dailyAllYearsChart;
let yearlyMaxChart;

/* ===============================
   DATEN LADEN (EINMAL!)
================================ */

Promise.all([
  fetch("data.json").then(r=>r.json()),
  fetch("daily_tmax_1881_2026.json").then(r=>r.json())
])
.then(([monthly, daily]) => {
  monthlyData = monthly;
  dailyData = daily;

  initMonthly();
  initDaily();
  initExtremes();
})
.catch(err=>{
  console.error("Fehler beim Laden der Daten:", err);
});

/* ===============================
   MONATS-DASHBOARD
================================ */

function initMonthly(){
  updateMonthly();
  document.getElementById("paramSelect").addEventListener("change",updateMonthly);
  document.getElementById("monthSelect").addEventListener("change",updateMonthly);
}

function updateMonthly(){

  const param=document.getElementById("paramSelect").value;
  const month=document.getElementById("monthSelect").value;

  const filtered=monthlyData.filter(e=>e.date.endsWith("-"+month));
  const labels=filtered.map(e=>e.date.substring(0,4));
  const values=filtered.map(e=>e[param]);

  const climatePeriod=filtered.filter(e=>{
    const y=parseInt(e.date.substring(0,4));
    return y>=1991 && y<=2020;
  });

  const mean=climatePeriod.reduce((s,e)=>s+e[param],0)/climatePeriod.length;
  document.getElementById("climateMean").innerText = mean.toFixed(2);

  if(monthlyChart) monthlyChart.destroy();

  monthlyChart=new Chart(document.getElementById("monthlyChart"),{
    type:"bar",
    data:{ labels, datasets:[{ label:param, data:values, backgroundColor:"gray" }]},
    options:{responsive:true,maintainAspectRatio:false}
  });

  let dev = param==="rain"
    ? values.map(v => (v/mean)*100)
    : values.map(v => v-mean);

  if(monthlyDeviationChart) monthlyDeviationChart.destroy();

  monthlyDeviationChart=new Chart(
    document.getElementById("monthlyDeviationChart"),
    {
      type:"bar",
      data:{
        labels,
        datasets:[{
          data:dev,
          backgroundColor:dev.map(v=>{
            if(param==="rain") return v>=100?"green":"saddlebrown";
            return v>=0?"red":"blue";
          })
        }]
      },
      options:{responsive:true,maintainAspectRatio:false}
    }
  );
}

function resetMonthlyZoom(){
  if(monthlyChart) monthlyChart.resetZoom();
}

/* ===============================
   TAGES-DASHBOARD
================================ */

function initDaily(){

  const years=[...new Set(dailyData.map(d=>d.date.substring(0,4)))];
  const sel=document.getElementById("yearSelect");

  years.forEach(y=>{
    const o=document.createElement("option");
    o.value=y; o.text=y;
    sel.appendChild(o);
  });

  sel.value=years[years.length-1];

  document.getElementById("yearSelect").addEventListener("change",updateDaily);
  document.getElementById("rangeSelect").addEventListener("change",updateDaily);

  updateDaily();
}

function updateDaily(){

  const year=document.getElementById("yearSelect").value;
  const filtered=dailyData.filter(d=>d.date.startsWith(year));

  const labels=filtered.map(d=>d.date);
  const values=filtered.map(d=>d.tmax);

  if(dailyChart) dailyChart.destroy();

  dailyChart=new Chart(document.getElementById("dailyChart"),{
    type:"line",
    data:{
      labels,
      datasets:[
        {data:values, borderColor:"red", pointRadius:0}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });
}

/* ===============================
   EXTREME
================================ */

function initExtremes(){

  const years=[...new Set(dailyData.map(d=>d.date.substring(0,4)))];
  let yearlyMax={};

  years.forEach(y=>yearlyMax[y]=-999);

  dailyData.forEach(d=>{
    const y=d.date.substring(0,4);
    if(d.tmax>yearlyMax[y]) yearlyMax[y]=d.tmax;
  });

  const values=years.map(y=>yearlyMax[y]);
  const absoluteMax=Math.max(...values);

  yearlyMaxChart=new Chart(
    document.getElementById("yearlyMaxChart"),
    {
      type:"bar",
      data:{
        labels:years,
        datasets:[{
          data:values,
          backgroundColor:values.map(v=>v===absoluteMax?"darkred":"rgba(255,0,0,0.6)")
        }]
      },
      options:{responsive:true,maintainAspectRatio:false}
    }
  );
}

function resetYearlyMaxZoom(){
  if(yearlyMaxChart) yearlyMaxChart.resetZoom();
}

</script>
