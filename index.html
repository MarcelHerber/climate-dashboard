<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Climate Dashboard Deutschland</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<style>
body{
  font-family:Arial,sans-serif;
  padding:30px;
  background:#f4f6f8;
}

.tabs{
  display:flex;
  gap:20px;
  margin-bottom:30px;
}

.tab-button{
  padding:10px 20px;
  cursor:pointer;
  background:#ddd;
  border:none;
  border-radius:6px;
  font-weight:bold;
}

.tab-button.active{
  background:#444;
  color:white;
}

.tab-content{ display:none; }
.tab-content.active{ display:block; }

.chart-container{
  max-width:1500px;
  height:500px;
  margin:40px auto;
  background:white;
  padding:20px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

.stats{
  max-width:900px;
  margin:40px auto;
  background:white;
  padding:20px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

canvas{
  width:100% !important;
  height:100% !important;
}
button{
  padding:8px 16px;
  margin-top:10px;
}
</style>
</head>
<body>

<h1>Climate Dashboard Deutschland</h1>

<div class="tabs">
  <button class="tab-button active" onclick="switchTab('monthly')">Monatswerte</button>
  <button class="tab-button" onclick="switchTab('daily')">Tageshöchstwerte</button>
</div>

<!-- ================= MONATS DASHBOARD ================= -->

<div id="monthly" class="tab-content active">

<label>Parameter:</label>
<select id="paramSelect">
  <option value="rain">Niederschlag</option>
  <option value="temp">Temperatur</option>
  <option value="sun">Sonnenscheindauer</option>
</select>

<label>Monat:</label>
<select id="monthSelect">
  <option value="01">Januar</option>
  <option value="02">Februar</option>
  <option value="03">März</option>
  <option value="04">April</option>
  <option value="05">Mai</option>
  <option value="06">Juni</option>
  <option value="07">Juli</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Dezember</option>
</select>

<button onclick="resetMonthlyZoom()">Zoom zurücksetzen</button>

<div class="chart-container">
  <canvas id="monthlyChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="monthlyDeviationChart"></canvas>
</div>

<div class="stats">
  <h3>Statistik (1991-2020)</h3>
  <p><strong>Mittelwert:</strong> <span id="climateMean"></span></p>
</div>

</div>

<!-- ================= TAGES DASHBOARD ================= -->

<div id="daily" class="tab-content">

<label>Jahr:</label>
<select id="yearSelect"></select>

<label>Zeitraum:</label>
<select id="rangeSelect">
  <option value="year">Ganzes Jahr</option>
  <option value="winter">Winter</option>
  <option value="spring">Frühling</option>
  <option value="summer">Sommer</option>
  <option value="autumn">Herbst</option>
  <option value="01">Januar</option>
  <option value="02">Februar</option>
  <option value="03">März</option>
  <option value="04">April</option>
  <option value="05">Mai</option>
  <option value="06">Juni</option>
  <option value="07">Juli</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Dezember</option>
</select>

<div class="chart-container">
  <canvas id="dailyChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="dailyDeviationChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="dailyAllYearsChart"></canvas>
  <button onclick="resetAllYearsZoom()">Zoom zurücksetzen</button>
</div>

</div>

<script>

// ---------- TAB SWITCH ----------
function switchTab(tab){
  document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add("active");
  document.getElementById(tab).classList.add("active");
}

// ---------- MONATS DATEN ----------
let monthlyData=[];
let monthlyChart;
let monthlyDeviationChart;

fetch("data.json")
.then(res=>res.json())
.then(data=>{
  monthlyData=data;
  updateMonthly();
});

function updateMonthly(){
  const param=document.getElementById("paramSelect").value;
  const month=document.getElementById("monthSelect").value;

  const filtered=monthlyData.filter(e=>e.date.endsWith("-"+month));
  const labels=filtered.map(e=>e.date.substring(0,4));
  const values=filtered.map(e=>e[param]);

  const climatePeriod=filtered.filter(e=>{
    const y=parseInt(e.date.substring(0,4));
    return y>=1991 && y<=2020;
  });

  const climateMean=
    climatePeriod.reduce((s,e)=>s+e[param],0)/climatePeriod.length;

  document.getElementById("climateMean").innerText=
    climateMean.toFixed(2);

  if(monthlyChart) monthlyChart.destroy();

  monthlyChart=new Chart(document.getElementById("monthlyChart"),{
    type:"bar",
    data:{ labels:labels, datasets:[{ label:param, data:values, backgroundColor:"gray" }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        zoom:{
          pan:{enabled:true,mode:"x"},
          zoom:{wheel:{enabled:true},mode:"x"}
        }
      }
    }
  });

  const deviation=values.map(v=>v-climateMean);

  if(monthlyDeviationChart) monthlyDeviationChart.destroy();

  monthlyDeviationChart=new Chart(document.getElementById("monthlyDeviationChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[
        {
          label:"Abweichung",
          data:deviation,
          backgroundColor:deviation.map(v=>v>=0?"red":"blue")
        }
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });
}

function resetMonthlyZoom(){
  if(monthlyChart) monthlyChart.resetZoom();
}

document.getElementById("paramSelect").addEventListener("change",updateMonthly);
document.getElementById("monthSelect").addEventListener("change",updateMonthly);

// ---------- TAGES DATEN ----------
let dailyData=[];
let dailyChart;
let dailyDeviationChart;
let dailyAllYearsChart;

fetch("daily_tmax_1881_2026.json")
.then(res=>res.json())
.then(data=>{
  dailyData=data;
  const years=[...new Set(data.map(d=>d.date.substring(0,4)))];
  const select=document.getElementById("yearSelect");
  years.forEach(y=>{
    const opt=document.createElement("option");
    opt.value=y;
    opt.text=y;
    select.appendChild(opt);
  });
  select.value=years[years.length-1];
  updateDaily();
});

function updateDaily(){

  const year=document.getElementById("yearSelect").value;
  const range=document.getElementById("rangeSelect").value;

  const seasonMap={
    winter:["12","01","02"],
    spring:["03","04","05"],
    summer:["06","07","08"],
    autumn:["09","10","11"]
  };

  let filtered=dailyData.filter(d=>d.date.startsWith(year));

  if(range!=="year"){
    if(seasonMap[range]){
      filtered=filtered.filter(d=>seasonMap[range].includes(d.date.substring(5,7)));
    } else {
      filtered=filtered.filter(d=>d.date.substring(5,7)===range);
    }
  }

  const labels=filtered.map(d=>d.date);
  const values=filtered.map(d=>d.tmax);
  const climate=filtered.map(d=>d.climate_mean);
  const deviation=filtered.map(d=>d.tmax-d.climate_mean);

  if(dailyChart) dailyChart.destroy();
  dailyChart=new Chart(document.getElementById("dailyChart"),{
    type:"line",
    data:{
      labels:labels,
      datasets:[
        { label:"Tageswert", data:values, borderColor:"red", pointRadius:0 },
        { label:"Klimamittel", data:climate, borderColor:"black", borderDash:[6,6], pointRadius:0 }
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });

  if(dailyDeviationChart) dailyDeviationChart.destroy();
  dailyDeviationChart=new Chart(document.getElementById("dailyDeviationChart"),{
    type:"line",
    data:{
      labels:labels,
      datasets:[
        {
          label:"Abweichung (°C)",
          data:deviation,
          fill:"origin",
          pointRadius:0,
          segment:{
            borderColor:ctx=>{
              const avg=(ctx.p0.parsed.y+ctx.p1.parsed.y)/2;
              return avg>=0?"red":"blue";
            },
            backgroundColor:ctx=>{
              const avg=(ctx.p0.parsed.y+ctx.p1.parsed.y)/2;
              return avg>=0
                ?"rgba(255,0,0,0.25)"
                :"rgba(0,150,255,0.25)";
            }
          }
        }
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });

  if(dailyAllYearsChart) dailyAllYearsChart.destroy();

  const allYears=[...new Set(dailyData.map(d=>d.date.substring(0,4)))];
  let datasets=[];

  allYears.forEach(y=>{
    let yearData=dailyData.filter(d=>d.date.startsWith(y));
    if(range!=="year"){
      if(seasonMap[range]){
        yearData=yearData.filter(d=>seasonMap[range].includes(d.date.substring(5,7)));
      } else {
        yearData=yearData.filter(d=>d.date.substring(5,7)===range);
      }
    }

    datasets.push({
      data:yearData.map(d=>d.tmax),
      borderColor:y===year?"red":"rgba(0,0,255,0.05)",
      borderWidth:y===year?2:1,
      pointRadius:0
    });
  });

  datasets.push({
    data:filtered.map(d=>d.climate_mean),
    borderColor:"black",
    borderWidth:3,
    pointRadius:0
  });

  dailyAllYearsChart=new Chart(
    document.getElementById("dailyAllYearsChart"),
    {
      type:"line",
      data:{ labels:labels, datasets:datasets },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ display:false },
          zoom:{
            pan:{ enabled:true, mode:"x" },
            zoom:{ wheel:{enabled:true}, drag:{enabled:true}, mode:"x" }
          }
        }
      }
    }
  );
}

function resetAllYearsZoom(){
  if(dailyAllYearsChart){
    dailyAllYearsChart.resetZoom();
  }
}

document.getElementById("yearSelect").addEventListener("change",updateDaily);
document.getElementById("rangeSelect").addEventListener("change",updateDaily);

</script>
</body>
</html>
