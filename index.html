<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Climate Dashboard Deutschland</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<style>
body{
  font-family:Arial,sans-serif;
  padding:30px;
  background:#f4f6f8;
}

.tabs{
  display:flex;
  gap:20px;
  margin-bottom:30px;
}

.tab-button{
  padding:10px 20px;
  cursor:pointer;
  background:#ddd;
  border:none;
  border-radius:6px;
  font-weight:bold;
}

.tab-button.active{
  background:#444;
  color:white;
}

.tab-content{ display:none; }
.tab-content.active{ display:block; }

.chart-container{
  max-width:1400px;
  height:450px;
  margin:30px auto;
  background:white;
  padding:20px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

button{
  padding:8px 14px;
  margin-top:10px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:white;
}

th,td{
  padding:8px;
  border:1px solid #ccc;
  text-align:center;
}
</style>
</head>
<body>

<h1>Climate Dashboard Deutschland</h1>

<div class="tabs">
  <button class="tab-button active" onclick="switchTab('monthly')">Monatswerte</button>
  <button class="tab-button" onclick="switchTab('daily')">Tageshöchstwerte</button>
  <button class="tab-button" onclick="switchTab('extremes')">Kenntage</button>
</div>

<!-- ================= MONATSDASHBOARD ================= -->

<div id="monthly" class="tab-content active">

<label>Parameter:</label>
<select id="paramSelect">
  <option value="rain">Niederschlag</option>
  <option value="temp">Temperatur</option>
  <option value="sun">Sonnenscheindauer</option>
</select>

<label>Monat:</label>
<select id="monthSelect">
  <option value="01">Januar</option>
  <option value="02">Februar</option>
  <option value="03">März</option>
  <option value="04">April</option>
  <option value="05">Mai</option>
  <option value="06">Juni</option>
  <option value="07">Juli</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Dezember</option>
</select>

<button onclick="resetMonthlyZoom()">Zoom zurücksetzen</button>

<div class="chart-container">
  <canvas id="monthlyChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="monthlyDeviationChart"></canvas>
</div>

</div>

<!-- ================= TAGESDASHBOARD ================= -->

<div id="daily" class="tab-content">

<label>Jahr:</label>
<select id="yearSelect"></select>

<label>Zeitraum:</label>
<select id="rangeSelect">
  <option value="year">Ganzes Jahr</option>
  <option value="winter">Winter</option>
  <option value="spring">Frühling</option>
  <option value="summer">Sommer</option>
  <option value="autumn">Herbst</option>
  <option value="01">Januar</option>
  <option value="02">Februar</option>
  <option value="03">März</option>
  <option value="04">April</option>
  <option value="05">Mai</option>
  <option value="06">Juni</option>
  <option value="07">Juli</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Dezember</option>
</select>

<div class="chart-container">
  <canvas id="dailyChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="dailyDeviationChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="dailyAllYearsChart"></canvas>
  <button onclick="resetAllYearsZoom()">Zoom zurücksetzen</button>
</div>

</div>

<!-- ================= KENNTAGE ================= -->

<div id="extremes" class="tab-content">

<div class="chart-container">
  <canvas id="yearlyExtremeChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="monthlyExtremeChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="seasonExtremeChart"></canvas>
</div>

<h3>Top 30 heißeste Tage seit 1881</h3>
<table id="topHotDaysTable">
<thead>
<tr>
<th>Rang</th>
<th>Datum</th>
<th>°C</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>

// TAB SWITCH
function switchTab(tab){
  document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add("active");
  document.getElementById(tab).classList.add("active");
}

// ================= MONATSDATEN =================

let monthlyData=[], monthlyChart, monthlyDeviationChart;

fetch("data.json")
.then(r=>r.json())
.then(data=>{
  monthlyData=data;
  updateMonthly();
});

function updateMonthly(){
  const param=document.getElementById("paramSelect").value;
  const month=document.getElementById("monthSelect").value;

  const filtered=monthlyData.filter(e=>e.date.endsWith("-"+month));
  const labels=filtered.map(e=>e.date.substring(0,4));
  const values=filtered.map(e=>e[param]);

  const climatePeriod=filtered.filter(e=>{
    const y=parseInt(e.date.substring(0,4));
    return y>=1991 && y<=2020;
  });

  const mean=climatePeriod.reduce((s,e)=>s+e[param],0)/climatePeriod.length;

  if(monthlyChart) monthlyChart.destroy();

  monthlyChart=new Chart(document.getElementById("monthlyChart"),{
    type:"bar",
    data:{ labels:labels, datasets:[{ label:param, data:values, backgroundColor:"gray" }]},
    options:{responsive:true,maintainAspectRatio:false}
  });

  const dev=values.map(v=>v-mean);

  if(monthlyDeviationChart) monthlyDeviationChart.destroy();

  monthlyDeviationChart=new Chart(document.getElementById("monthlyDeviationChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[{ label:"Abweichung", data:dev, backgroundColor:dev.map(v=>v>=0?"red":"blue")}]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });
}

function resetMonthlyZoom(){
  if(monthlyChart) monthlyChart.resetZoom();
}

document.getElementById("paramSelect").addEventListener("change",updateMonthly);
document.getElementById("monthSelect").addEventListener("change",updateMonthly);

// ================= TAGESDATEN =================

let dailyData=[], dailyChart, dailyDeviationChart, dailyAllYearsChart;

fetch("daily_tmax_1881_2026.json")
.then(r=>r.json())
.then(data=>{
  dailyData=data;
  const years=[...new Set(data.map(d=>d.date.substring(0,4)))];
  const sel=document.getElementById("yearSelect");
  years.forEach(y=>{
    const o=document.createElement("option");
    o.value=y; o.text=y;
    sel.appendChild(o);
  });
  sel.value=years[years.length-1];
  updateDaily();
});

function updateDaily(){

  const year=document.getElementById("yearSelect").value;
  const range=document.getElementById("rangeSelect").value;

  const seasonMap={
    winter:["12","01","02"],
    spring:["03","04","05"],
    summer:["06","07","08"],
    autumn:["09","10","11"]
  };

  let filtered=dailyData.filter(d=>d.date.startsWith(year));

  if(range==="winter"){
    const prev=(parseInt(year)-1).toString();
    filtered=dailyData.filter(d=>{
      const y=d.date.substring(0,4);
      const m=d.date.substring(5,7);
      return (y===prev && m==="12") || (y===year && (m==="01"||m==="02"));
    });
  }
  else if(range!=="year"){
    if(seasonMap[range]){
      filtered=filtered.filter(d=>seasonMap[range].includes(d.date.substring(5,7)));
    } else {
      filtered=filtered.filter(d=>d.date.substring(5,7)===range);
    }
  }

  const labels=filtered.map(d=>d.date);
  const values=filtered.map(d=>d.tmax);
  const climate=filtered.map(d=>d.climate_mean);
  const deviation=filtered.map(d=>d.tmax-d.climate_mean);

  if(dailyChart) dailyChart.destroy();
  dailyChart=new Chart(document.getElementById("dailyChart"),{
    type:"line",
    data:{
      labels:labels,
      datasets:[
        { label:"Tageswert", data:values, borderColor:"red", pointRadius:0 },
        { label:"Klimamittel", data:climate, borderColor:"black", borderDash:[6,6], pointRadius:0 }
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });

  if(dailyDeviationChart) dailyDeviationChart.destroy();
  dailyDeviationChart=new Chart(document.getElementById("dailyDeviationChart"),{
    type:"line",
    data:{
      labels:labels,
      datasets:[
        {
          label:"Abweichung (°C)",
          data:deviation,
          fill:"origin",
          pointRadius:0,
          segment:{
            borderColor:ctx=>{
              const avg=(ctx.p0.parsed.y+ctx.p1.parsed.y)/2;
              return avg>=0?"red":"blue";
            },
            backgroundColor:ctx=>{
              const avg=(ctx.p0.parsed.y+ctx.p1.parsed.y)/2;
              return avg>=0?"rgba(255,0,0,0.25)":"rgba(0,150,255,0.25)";
            }
          }
        }
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });

  if(dailyAllYearsChart) dailyAllYearsChart.destroy();

  const allYears=[...new Set(dailyData.map(d=>d.date.substring(0,4)))];
  let datasets=[];

  allYears.forEach(y=>{
    let yd=dailyData.filter(d=>d.date.startsWith(y));
    if(range!=="year"){
      if(seasonMap[range]){
        yd=yd.filter(d=>seasonMap[range].includes(d.date.substring(5,7)));
      } else {
        yd=yd.filter(d=>d.date.substring(5,7)===range);
      }
    }
    datasets.push({
      data:yd.map(d=>d.tmax),
      borderColor:y===year?"red":"rgba(0,0,255,0.05)",
      borderWidth:y===year?2:1,
      pointRadius:0
    });
  });

  datasets.push({
    data:filtered.map(d=>d.climate_mean),
    borderColor:"black",
    borderWidth:3,
    pointRadius:0
  });

  dailyAllYearsChart=new Chart(
    document.getElementById("dailyAllYearsChart"),
    {
      type:"line",
      data:{labels:labels,datasets:datasets},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          zoom:{
            pan:{enabled:true,mode:"x"},
            zoom:{wheel:{enabled:true},drag:{enabled:true},mode:"x"}
          }
        }
      }
    }
  );
}

function resetAllYearsZoom(){
  if(dailyAllYearsChart) dailyAllYearsChart.resetZoom();
}

document.getElementById("yearSelect").addEventListener("change",updateDaily);
document.getElementById("rangeSelect").addEventListener("change",updateDaily);

// ================= KENNTAGE =================

fetch("daily_tmax_1881_2026.json")
.then(r=>r.json())
.then(data=>{

  const years=[...new Set(data.map(d=>d.date.substring(0,4)))];

  let yearlySummer={}, yearlyHot={}, yearlyVeryHot={};
  years.forEach(y=>{
    yearlySummer[y]=0;
    yearlyHot[y]=0;
    yearlyVeryHot[y]=0;
  });

  data.forEach(d=>{
    const y=d.date.substring(0,4);
    if(d.tmax>=25) yearlySummer[y]++;
    if(d.tmax>=30) yearlyHot[y]++;
    if(d.tmax>=35) yearlyVeryHot[y]++;
  });

  new Chart(document.getElementById("yearlyExtremeChart"),{
    type:"bar",
    data:{
      labels:years,
      datasets:[
        {label:"≥25°C", data:years.map(y=>yearlySummer[y]), backgroundColor:"orange"},
        {label:"≥30°C", data:years.map(y=>yearlyHot[y]), backgroundColor:"red"},
        {label:"≥35°C", data:years.map(y=>yearlyVeryHot[y]), backgroundColor:"darkred"}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false}
  });

  const top30=[...data].sort((a,b)=>b.tmax-a.tmax).slice(0,30);
  const tbody=document.querySelector("#topHotDaysTable tbody");
  top30.forEach((d,i)=>{
    tbody.innerHTML+=`<tr><td>${i+1}</td><td>${d.date}</td><td>${d.tmax.toFixed(1)}</td></tr>`;
  });

});

</script>
</body>
</html>
