<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Climate Dashboard Deutschland</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  padding: 40px;
  background-color: #f4f6f8;
}

.chart-container {
  width: 100%;
  max-width: 1500px;
  height: 600px;
  margin: 40px auto;
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

canvas {
  width: 100% !important;
  height: 100% !important;
}

.stats {
  max-width: 900px;
  margin: 40px auto;
  background: white;
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  text-align: left;
}

select, button {
  padding: 10px 16px;
  margin: 12px;
  font-size: 16px;
}
</style>
</head>

<body>

<h1>Climate Dashboard Deutschland</h1>

<label>Parameter:</label>
<select id="paramSelect">
  <option value="rain">Niederschlag</option>
  <option value="temp">Temperatur</option>
  <option value="sun">Sonnenscheindauer</option>
</select>

<label>Monat:</label>
<select id="monthSelect">
  <option value="01">Januar</option>
  <option value="02">Februar</option>
  <option value="03">März</option>
  <option value="04">April</option>
  <option value="05">Mai</option>
  <option value="06">Juni</option>
  <option value="07">Juli</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Dezember</option>
</select>

<button onclick="resetZoom()">Zoom zurücksetzen</button>

<div class="chart-container">
  <canvas id="mainChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="percentChart"></canvas>
</div>

<div class="stats">
  <h3>Statistik (1991–2020)</h3>
  <p><strong>Mittelwert:</strong> <span id="climateMean"></span></p>

  <h4>Top 3 höchste</h4>
  <ul id="topHigh"></ul>

  <h4>Top 3 niedrigste</h4>
  <ul id="topLow"></ul>
</div>

<script>

let mainChart;
let percentChart;
let originalData = [];

fetch('data.json')
.then(res=>res.json())
.then(data=>{
  originalData=data;
  updateCharts();
});

function updateCharts(){

  const param=document.getElementById("paramSelect").value;
  const month=document.getElementById("monthSelect").value;

  const filtered=originalData.filter(e=>e.date.endsWith("-"+month));
  const labels=filtered.map(e=>e.date.substring(0,4));
  const values=filtered.map(e=>e[param]);

  const climatePeriod=filtered.filter(e=>{
    const y=parseInt(e.date.substring(0,4));
    return y>=1991 && y<=2020;
  });

  const climateMean=
    climatePeriod.reduce((s,e)=>s+e[param],0)/climatePeriod.length;

  // Einheit
  let unit="";
  if(param==="rain") unit="mm";
  if(param==="temp") unit="°C";
  if(param==="sun") unit="Stunden";

  document.getElementById("climateMean").innerText=
    climateMean.toFixed(2)+" "+unit;

  // Top 3
  const sortedHigh=[...filtered].sort((a,b)=>b[param]-a[param]).slice(0,3);
  const sortedLow=[...filtered].sort((a,b)=>a[param]-b[param]).slice(0,3);

  document.getElementById("topHigh").innerHTML="";
  sortedHigh.forEach(e=>{
    document.getElementById("topHigh").innerHTML+=
      `<li>${e.date.substring(0,4)}: ${e[param]} ${unit}</li>`;
  });

  document.getElementById("topLow").innerHTML="";
  sortedLow.forEach(e=>{
    document.getElementById("topLow").innerHTML+=
      `<li>${e.date.substring(0,4)}: ${e[param]} ${unit}</li>`;
  });

  // 30-Jahre gleitendes Mittel
  const movingAverage = values.map((_,i)=>{
    if(i<29) return null;
    const slice=values.slice(i-29,i+1);
    return slice.reduce((a,b)=>a+b,0)/30;
  });

  if(mainChart) mainChart.destroy();

  mainChart=new Chart(document.getElementById("mainChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[
        {
          label:param+" ("+unit+")",
          data:values,
          backgroundColor:"gray"
        },
        {
          label:"30-jähriges Mittel",
          data:movingAverage,
          type:"line",
          borderColor:"black",
          borderWidth:3,
          pointRadius:0
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{
          ticks:{
            autoSkip:false,
            callback:function(value,index){
              if(index%20===0) return labels[index];
              return '';
            }
          }
        }
      },
      plugins:{
        zoom:{
          pan:{enabled:true,mode:"x"},
          zoom:{
            wheel:{enabled:true},
            drag:{enabled:true},
            mode:"x"
          }
        }
      }
    }
  });

  // Prozentabweichung
  const percentValues=values.map(v=>
    ((v/climateMean)*100)-100
  );

  let colors;

  if(param==="temp"){
    colors=percentValues.map(v=>v>=0?"red":"blue");
  } else {
    colors=percentValues.map(v=>v>=0?"green":"brown");
  }

  if(percentChart) percentChart.destroy();

  percentChart=new Chart(document.getElementById("percentChart"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[
        {
          label:"% Abweichung",
          data:percentValues,
          backgroundColor:colors
        },
        {
          label:"0 % Linie",
          data:new Array(percentValues.length).fill(0),
          type:"line",
          borderColor:"black",
          borderDash:[6,6],
          pointRadius:0
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{
          ticks:{
            autoSkip:false,
            callback:function(value,index){
              if(index%20===0) return labels[index];
              return '';
            }
          }
        }
      }
    }
  });
}

document.getElementById("paramSelect")
.addEventListener("change",updateCharts);

document.getElementById("monthSelect")
.addEventListener("change",updateCharts);

function resetZoom(){
  if(mainChart) mainChart.resetZoom();
}

</script>

</body>
</html>
