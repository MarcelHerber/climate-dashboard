<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Climate Dashboard Deutschland</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<style>
body{font-family:Arial,sans-serif;padding:30px;background:#f4f6f8;}
.tabs{display:flex;gap:20px;margin-bottom:30px;}
.tab-button{padding:10px 20px;cursor:pointer;background:#ddd;border:none;border-radius:6px;font-weight:bold;}
.tab-button.active{background:#444;color:white;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.chart-container{max-width:1400px;height:450px;margin:30px auto;background:white;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.08);}
table{width:100%;border-collapse:collapse;margin-top:20px;background:white;}
th,td{padding:8px;border:1px solid #ccc;text-align:center;}
</style>
</head>
<body>

<h1>Climate Dashboard Deutschland</h1>

<div class="tabs">
  <button class="tab-button active" onclick="switchTab('monthly')">Monatswerte</button>
  <button class="tab-button" onclick="switchTab('daily')">Tagesh√∂chstwerte</button>
  <button class="tab-button" onclick="switchTab('extremes')">Kenntage</button>
</div>

<!-- ================= MONATSWERTE ================= -->

<div id="monthly" class="tab-content active">

<label>Parameter:</label>
<select id="paramSelect">
  <option value="rain">Niederschlag</option>
  <option value="temp">Temperatur</option>
  <option value="sun">Sonnenscheindauer</option>
</select>

<label>Monat:</label>
<select id="monthSelect">
  <option value="01">Januar</option>
  <option value="02">Februar</option>
  <option value="03">M√§rz</option>
  <option value="04">April</option>
  <option value="05">Mai</option>
  <option value="06">Juni</option>
  <option value="07">Juli</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Dezember</option>
  <option value="winter">Winter (DJF)</option>
  <option value="spring">Fr√ºhling (MAM)</option>
  <option value="summer">Sommer (JJA)</option>
  <option value="autumn">Herbst (SON)</option>
</select>

<button onclick="resetMonthlyZoom()">Zoom zur√ºcksetzen</button>

<div class="chart-container">
  <canvas id="monthlyChart"></canvas>
</div>

<div class="chart-container" style="height:auto;">
  <h3>Statistik</h3>
  <p><strong>Mittel 1991‚Äì2020:</strong> <span id="climateMean"></span></p>

  <h4>Top 3 h√∂chste Werte</h4>
  <ul id="top3High"></ul>

  <h4>Top 3 niedrigste Werte</h4>
  <ul id="top3Low"></ul>
</div>

<div class="chart-container">
  <canvas id="monthlyDeviationChart"></canvas>
</div>

</div>

<!-- ================= TAGESWERTE ================= -->

<div id="daily" class="tab-content">

<label>Jahr:</label>
<select id="yearSelect"></select>

<label>Zeitraum:</label>
<select id="rangeSelect">
  <option value="year">Ganzes Jahr</option>
  <option value="winter">Winter</option>
  <option value="spring">Fr√ºhling</option>
  <option value="summer">Sommer</option>
  <option value="autumn">Herbst</option>
  <option value="01">Januar</option>
  <option value="02">Februar</option>
  <option value="03">M√§rz</option>
  <option value="04">April</option>
  <option value="05">Mai</option>
  <option value="06">Juni</option>
  <option value="07">Juli</option>
  <option value="08">August</option>
  <option value="09">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Dezember</option>
</select>

<div class="chart-container">
  <canvas id="dailyChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="dailyDeviationChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="dailyAllYearsChart"></canvas>
  <button onclick="resetAllYearsZoom()">Zoom zur√ºcksetzen</button>
</div>

</div>

<!-- ================= KENNTAGE ================= -->

<div id="extremes" class="tab-content">

<div class="chart-container">
  <canvas id="yearlyExtremeChart"></canvas>
</div>

<div class="chart-container">
  <canvas id="yearlyMaxChart"></canvas>
  <button onclick="resetYearlyMaxZoom()">Zoom zur√ºcksetzen</button>
</div>

<div class="chart-container">
  <canvas id="heatmapChart"></canvas>
</div>

<h3>Top 30 hei√üeste Tage seit 1881</h3>
<table id="topHotDaysTable">
<thead>
<tr><th>Rang</th><th>Datum</th><th>¬∞C</th></tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>

/* ================= TAB ================= */

function switchTab(tab){
  document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add("active");
  document.getElementById(tab).classList.add("active");
}

/* ================= MONATSWERTE ================= */

let monthlyData=[],monthlyChart,monthlyDeviationChart;

fetch("data.json")
.then(r=>r.json())
.then(data=>{
  monthlyData=data;
  updateMonthly();
});

function updateMonthly(){

  const param=document.getElementById("paramSelect").value;
  const selection=document.getElementById("monthSelect").value;

  const seasonMap={
    winter:["12","01","02"],
    spring:["03","04","05"],
    summer:["06","07","08"],
    autumn:["09","10","11"]
  };

  let filtered;

  if(seasonMap[selection]){
    filtered=monthlyData.filter(e=>{
      const m=e.date.substring(5,7);
      return seasonMap[selection].includes(m);
    });
  }else{
    filtered=monthlyData.filter(e=>e.date.endsWith("-"+selection));
  }

  const labels=[...new Set(filtered.map(e=>e.date.substring(0,4)))];

  const values=labels.map(y=>{
    const entries=filtered.filter(e=>e.date.startsWith(y));
    if(seasonMap[selection]){
      return entries.reduce((s,e)=>s+e[param],0)/entries.length;
    }
    return entries[0] ? entries[0][param] : null;
  });

  const climatePeriod=labels.filter(y=>y>=1991&&y<=2020);
  const climateValues=climatePeriod.map(y=>{
    const entries=filtered.filter(e=>e.date.startsWith(y));
    if(seasonMap[selection]){
      return entries.reduce((s,e)=>s+e[param],0)/entries.length;
    }
    return entries[0] ? entries[0][param] : null;
  });

  const mean=climateValues.reduce((s,v)=>s+v,0)/climateValues.length;
  document.getElementById("climateMean").innerText=mean.toFixed(2);

  const combined=labels.map((y,i)=>({year:y,value:values[i]}));
  const sortedHigh=[...combined].sort((a,b)=>b.value-a.value).slice(0,3);
  const sortedLow=[...combined].sort((a,b)=>a.value-b.value).slice(0,3);

  document.getElementById("top3High").innerHTML=
    sortedHigh.map(e=>`<li>${e.year}: ${e.value.toFixed(2)}</li>`).join("");

  document.getElementById("top3Low").innerHTML=
    sortedLow.map(e=>`<li>${e.year}: ${e.value.toFixed(2)}</li>`).join("");

  if(monthlyChart) monthlyChart.destroy();
  monthlyChart=new Chart(document.getElementById("monthlyChart"),{
    type:"bar",
    data:{labels,datasets:[{data:values,backgroundColor:"gray"}]},
    options:{responsive:true}
  });

  if(monthlyDeviationChart) monthlyDeviationChart.destroy();
  monthlyDeviationChart=new Chart(document.getElementById("monthlyDeviationChart"),{
    type:"bar",
    data:{labels,datasets:[{
      data:values.map(v=>v-mean),
      backgroundColor:values.map(v=>v>=mean?"red":"blue")
    }]},
    options:{responsive:true}
  });
}

function resetMonthlyZoom(){
  if(monthlyChart) monthlyChart.resetZoom();
}

document.getElementById("paramSelect").addEventListener("change",updateMonthly);
document.getElementById("monthSelect").addEventListener("change",updateMonthly);

/* ================= TAGESWERTE + EXTREMES ================= */

let dailyData=[],dailyChart,dailyDeviationChart,dailyAllYearsChart;

function getWinterLabels(year){
  const start=new Date(year-1,11,1);
  const end=new Date(year,2,0);
  const arr=[];
  let d=new Date(start);
  while(d<=end){
    arr.push(d.toISOString().split("T")[0]);
    d.setDate(d.getDate()+1);
  }
  return arr;
}

fetch("daily_tmax_1881_2026.json")
.then(r=>r.json())
.then(data=>{
  dailyData=data;
  initDaily();
  initExtremes();
});

/* ================= DAILY ================= */

function initDaily(){
  const years=[...new Set(dailyData.map(d=>d.date.substring(0,4)))];
  const sel=document.getElementById("yearSelect");
  years.forEach(y=>{
    const o=document.createElement("option");
    o.value=y;o.text=y;
    sel.appendChild(o);
  });
  sel.value=years[years.length-1];
  updateDaily();
}

function updateDaily(){
console.log("Anzahl Datens√§tze:", dailyData.length);
console.log("Erstes Datum:", dailyData[0]?.date);
console.log("Letztes Datum:", dailyData[dailyData.length-1]?.date);
  const year=document.getElementById("yearSelect").value;
  const range=document.getElementById("rangeSelect").value;

  const seasonMap={
    winter:["12","01","02"],
    spring:["03","04","05"],
    summer:["06","07","08"],
    autumn:["09","10","11"]
  };

  /* ================= FILTER AKTUELLES JAHR ================= */

  let filtered=dailyData.filter(d=>d.date.startsWith(year));

  if(range==="winter"){
    const prev=(parseInt(year)-1).toString();
    filtered=dailyData.filter(d=>{
      const y=d.date.substring(0,4);
      const m=d.date.substring(5,7);
      return (y===prev&&m==="12")||(y===year&&(m==="01"||m==="02"));
    });
  }
  else if(range!=="year"){
    if(seasonMap[range]){
      filtered=filtered.filter(d=>seasonMap[range].includes(d.date.substring(5,7)));
    }else{
      filtered=filtered.filter(d=>d.date.substring(5,7)===range);
    }
  }

  const labels=filtered.map(d=>d.date);

  /* ================= 1. GRAFIK ================= */

  if(dailyChart) dailyChart.destroy();
  dailyChart=new Chart(document.getElementById("dailyChart"),{
    type:"line",
    data:{labels,datasets:[
      {label:"Tageswert",data:filtered.map(d=>d.tmax),borderColor:"red",pointRadius:0},
      {label:"Klimamittel",data:filtered.map(d=>d.climate_mean),borderColor:"black",borderDash:[6,6],pointRadius:0}
    ]},
    options:{responsive:true}
  });

  /* ================= 2. GRAFIK ================= */

  if(dailyDeviationChart) dailyDeviationChart.destroy();
  dailyDeviationChart=new Chart(document.getElementById("dailyDeviationChart"),{
    type:"line",
    data:{labels,datasets:[{
      label:"Abweichung (¬∞C)",
      data:filtered.map(d=>d.tmax-d.climate_mean),
      fill:"origin",
      pointRadius:0,
      segment:{
        borderColor:ctx=>((ctx.p0.parsed.y+ctx.p1.parsed.y)/2)>=0?"red":"blue",
        backgroundColor:ctx=>((ctx.p0.parsed.y+ctx.p1.parsed.y)/2)>=0?
          "rgba(255,0,0,0.25)":"rgba(0,150,255,0.25)"
      }
    }]},
    options:{responsive:true}
  });

  /* ================= 3. GRAFIK (OVERLAY) ================= */

  if(dailyAllYearsChart) dailyAllYearsChart.destroy();

  const allYears=[...new Set(dailyData.map(d=>d.date.substring(0,4)))];
  let datasets=[];
  let labelsOverlay;

  // üîπ Labels f√ºr Overlay festlegen
  if(range==="winter"){
    const start=new Date(parseInt(year)-1,11,1);
    const end=new Date(parseInt(year),2,0);
    labelsOverlay=[];
    let d=new Date(start);
    while(d<=end){
      labelsOverlay.push(d.toISOString().split("T")[0]);
      d.setDate(d.getDate()+1);
    }
  }else{
    labelsOverlay=labels;
  }

  allYears.forEach(y=>{

    let yd=dailyData.filter(d=>d.date.startsWith(y));

    if(range==="winter"){
      const prev=(parseInt(y)-1).toString();
      yd=dailyData.filter(d=>{
        const yy=d.date.substring(0,4);
        const m=d.date.substring(5,7);
        return (yy===prev&&m==="12")||(yy===y&&(m==="01"||m==="02"));
      });
    }
    else if(range!=="year"){
      if(seasonMap[range]){
        yd=yd.filter(d=>seasonMap[range].includes(d.date.substring(5,7)));
      }else{
        yd=yd.filter(d=>d.date.substring(5,7)===range);
      }
    }

    const dataForChart=labelsOverlay.map(date=>{
      const entry=yd.find(d=>d.date===date);
      return entry?entry.tmax:null;
    });

    datasets.push({
      data:dataForChart,
      borderColor:y===year?"red":"rgba(0,0,255,0.08)",
      borderWidth:y===year?2:1,
      pointRadius:0,
      spanGaps:false
    });
  });

  dailyAllYearsChart=new Chart(
    document.getElementById("dailyAllYearsChart"),
    {
      type:"line",
      data:{labels:labelsOverlay,datasets},
      options:{
        plugins:{
          legend:{display:false},
          zoom:{
            pan:{enabled:true,mode:"x"},
            zoom:{wheel:{enabled:true},mode:"x"}
          }
        }
      }
    }
  );
}
function resetAllYearsZoom(){
  if(dailyAllYearsChart) dailyAllYearsChart.resetZoom();
}

/* ================= EXTREMES ================= */

function initExtremes(){

  const years=[...new Set(dailyData.map(d=>d.date.substring(0,4)))];

  let summer={},hot={},veryHot={},yearlyMax={};
  years.forEach(y=>{
    summer[y]=0;hot[y]=0;veryHot[y]=0;yearlyMax[y]=-999;
  });

  dailyData.forEach(d=>{
    const y=d.date.substring(0,4);
    if(d.tmax>=25) summer[y]++;
    if(d.tmax>=30) hot[y]++;
    if(d.tmax>=35) veryHot[y]++;
    if(d.tmax>yearlyMax[y]) yearlyMax[y]=d.tmax;
  });

  new Chart(document.getElementById("yearlyExtremeChart"),{
    type:"bar",
    data:{labels:years,datasets:[
      {label:"‚â•25¬∞C",data:years.map(y=>summer[y]),backgroundColor:"orange"},
      {label:"‚â•30¬∞C",data:years.map(y=>hot[y]),backgroundColor:"red"},
      {label:"‚â•35¬∞C",data:years.map(y=>veryHot[y]),backgroundColor:"darkred"}
    ]}
  });

  new Chart(document.getElementById("yearlyMaxChart"),{
    type:"bar",
    data:{labels:years,datasets:[
      {label:"Jahresh√∂chstwert",data:years.map(y=>yearlyMax[y]),backgroundColor:"red"}
    ]},
    options:{plugins:{zoom:{pan:{enabled:true,mode:"x"},zoom:{wheel:{enabled:true},mode:"x"}}}}
  });

  const monthCounts=Array(12).fill(0);
  dailyData.forEach(d=>{
    if(d.tmax>=30){
      const m=parseInt(d.date.substring(5,7))-1;
      monthCounts[m]++;
    }
  });

  new Chart(document.getElementById("heatmapChart"),{
    type:"bar",
    data:{labels:["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],
      datasets:[{data:monthCounts,backgroundColor:"red"}]}
  });

  const top30=[...dailyData].sort((a,b)=>b.tmax-a.tmax).slice(0,30);
  const tbody=document.querySelector("#topHotDaysTable tbody");
  tbody.innerHTML="";
  top30.forEach((d,i)=>{
    tbody.innerHTML+=`<tr><td>${i+1}</td><td>${d.date}</td><td>${d.tmax.toFixed(1)}</td></tr>`;
  });
}

</script>
</body>
</html>
